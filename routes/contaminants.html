<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.19.1/dist/bootstrap-table.min.css">
  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
    crossorigin="anonymous"></script>
  <script src="https://unpkg.com/bootstrap-table@1.19.1/dist/bootstrap-table.min.js"></script>
  <title>Contaminants & Safety Measures</title>
  <style>
    /*NAVBAR*/
    .navbar-nav .nav-item .nav-link {
      color: #444;
    }

    .navbar-nav .nav-item.active .nav-link,
    .navbar-nav .nav-item:hover .nav-link {
      color: #00b337;
    }

    /* NAVBAR END */
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container">
      <a class="navbar-brand" href="/"><strong
          style="font-weight: 700;font-size: 16px;letter-spacing: 1px; text-transform: uppercase; ">USARC Industrial
          Hygiene</strong></a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="facilities"><strong
                style="font-weight: 700;font-size: 16px;letter-spacing: 1px; text-transform: uppercase">Facilities</strong><span
                class="sr-only">(current)</span></a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="tests"><strong
                style="margin-left:2vw; font-weight: 700;font-size: 16px;letter-spacing: 1px; text-transform: uppercase">Tests</strong></a>
          </li>
          <li class="nav-item active">
            <a class="nav-link" href="contaminants"><strong
                style="margin-left:2vw; font-weight: 700;font-size: 16px;letter-spacing: 1px; text-transform: uppercase">Contaminants</strong></a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
  
  <br>

  <div class="container alert alert-success" id="mainAlert" role="alert" style="width:75%">
    <span></span>
    <button type="button" id="mainAlertCloseButton" class="close" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>

  <!-- CONTAMINANT -->
  <div class="container" style="width:80%">
    <div style="position:absolute;">
      <button type="button" class="btn btn-success" id="addContaminantButton" data-toggle="modal"
        data-target="#addContaminantModal">Add</button>
      <button type="button" class="btn btn-info" id="updateContaminantButton">Update</button>
      <button type="button" class="btn btn-danger" id="deleteContaminantButton">Delete</button>
    </div>
    <table id="contaminanttable"></table>
  </div>

  <div class="modal fade" id="addContaminantModal" tabindex="-1" role="dialog"
    aria-labelledby="addContaminantModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <form id="addContaminantForm" method="post">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Add a Contaminant</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
          <div class="modal-body">
            <div class="container alert alert-danger" id="addContaminantFailAlert" role="alert"
              style="margin-top:0px; margin-bottom:20px">
              <span></span>
              <button type="button" id="addContaminantFailAlertCloseButton" class="close" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="form-group"> <input class="form-control" name="contname" type="text"
                placeholder="Contaminant Name" required> </div>
            <div class="form-group"> <input class="form-control" name="threshold" type="number" step="any"
                placeholder="Warning Threshold" required> </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Discard</button>
            <button type="submit" class="btn btn-primary">Submit</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="updateContaminantModal" tabindex="-1" role="dialog" aria-labelledby="updateModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <form id="updateContaminantForm" method="post">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Update a Contaminant</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="modal-body">
              <div class="container alert alert-danger" id="updateContaminantFailAlert" role="alert"
                style="margin-top:0px; margin-bottom:20px">
                <span></span>
                <button type="button" id="updateContaminantFailAlertCloseButton" class="close" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="form-group"> <label for="updatecontname">Contaminant Name</label> <input class="form-control"
                  id="updatecontname" name="contname" type="text" placeholder="Contaminant Name" readonly="readonly"
                  required> </div>
              <div class="form-group"> <label for="updatethreshold">Warning Threshold</label> <input
                  class="form-control" id="updatethreshold" name="threshold" type="number" step="any"
                  placeholder="Warning Threshold" required> </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Discard</button>
            <button type="submit" class="btn btn-primary">Submit</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    $('#mainAlertCloseButton').on('click', function (e) {
      $('#mainAlert').hide();
    });
    $('#mainAlert').hide();

    $('#addContaminantFailAlertCloseButton').on('click', function (e) {
      $('#addContaminantFailAlert').hide();
    });
    $('#addContaminantFailAlert').hide();

    $('#updateContaminantFailAlertCloseButton').on('click', function (e) {
      $('#updateContaminantFailAlert').hide();
    });
    $('#updateContaminantFailAlert').hide();

    var $contaminanttable = $('#contaminanttable');

    function showSuccessAlert(msg) {
      $('#mainAlert').removeClass('alert-danger').addClass('alert-success');
      $('#mainAlert').children('span').first().text(msg);
      $('#mainAlert').show();
    }

    function showFailAlert(msg) {
      $('#mainAlert').removeClass('alert-success').addClass('alert-danger');
      $('#mainAlert').children('span').first().text(msg);
      $('#mainAlert').show();
    }

    function refreshContaminantTable() {
      $contaminanttable.bootstrapTable('destroy');
      loadContaminants();
    }

    $('#addContaminantForm').submit(function (e) {
      e.preventDefault();
      $.ajax({
        type: 'POST',
        url: '/addcontaminant',
        data: $(this).serialize(),
        success: msg => {
          showSuccessAlert(msg);
          $('#addContaminantModal').modal('hide');
          $("#addContaminantForm").trigger('reset');
          refreshContaminantTable();
        },
        error: msg => {
          $('#addContaminantFailAlert').children('span').first().text(msg.responseText);
          $('#addContaminantFailAlert').show();
        },
      });
    })

    $('#updateContaminantForm').submit(function (e) {
      e.preventDefault();
      $.ajax({
        type: 'POST',
        url: '/updatecontaminant',
        data: $(this).serialize(),
        success: msg => {
          showSuccessAlert(msg);
          $('#updateContaminantModal').modal('hide');
          $("#updateContaminantForm").trigger('reset');
          refreshContaminantTable();
        },
        error: msg => {
          $('#updateContaminantFailAlert').children('span').first().text(msg.responseText);
          $('#updateContaminantFailAlert').show();
        },
      });
    })

    function loadContaminants() {
      fetch('/getcontaminants').then(response => response.text().then(rows => {
        rows = JSON.parse(rows);
        $contaminanttable.bootstrapTable({
          clickToSelect: true,
          multipleSelectRow: true,
          // onDblClickRow: function (row, $element, field) { $('#updateModal').modal('show'); fillUpdateForm(row); },
          pagination: true,
          pageSize: 5,
          search: true,
          columns: [{
            field: 'checkbox',
            checkbox: true,
          }, {
            field: 'contname',
            title: 'Contaminant Name'
          }, {
            field: 'threshold',
            title: 'Warning Threshold'
          }
          ],
          data: rows
        });
      }));
    }
    loadContaminants();

    function fillContaminantUpdateForm(row) {
      for (let key in row) {
        if (key == 'checkbox') { continue; }
        else {
          let value = row[key];
          document.getElementById(`update${key}`).setAttribute('value', value);
        }
      }
    }

    var $updateContaminantButton = $('#updateContaminantButton');
    $(function () {
      $updateContaminantButton.click(function () {
        $('#updateContaminantFailAlert').hide();
        rows = $contaminanttable.bootstrapTable('getSelections');
        if (rows.length < 1) {
          alert("Please select a contaminant to update.");
        }
        else if (rows.length > 1) {
          alert("Multiple contaminants are selected. Please click on a single contaminant to update.");
        }
        else {
          $('#updateContaminantModal').modal('show');
          fillContaminantUpdateForm(rows[0]);
        }
      })
    });

    var $deleteContaminantButton = $('#deleteContaminantButton');
    $(function () {
      $deleteContaminantButton.click(function () {
        rows = $contaminanttable.bootstrapTable('getSelections');
        if (rows.length < 1) {
          alert("Please select a contaminant to delete.");
        }
        else if (rows.length > 1) {
          alert("Multiple contaminants are selected. Please select a single contaminant to delete.");
          /*
          let alertMultipleContaminantText = "You have selected multiple contaminants to delete: ";
          for (let index in rows) {
              alertMultipleContaminantText += `${rows[index].contname}, `;
          }
          alertMultipleContaminantText = alertMultipleContaminantText.substring(0, alertMultipleContaminantText.length-2);
          alertMultipleContaminantText += ". Do you want to proceed?"
          if (confirm(alertMultipleContaminantText)) {
            // deleteMultipleFacilities(...);
            console.log('Deleted multiple contaminants.');
          } else {
            console.log('Canceled multiple deletion.');
          }*/
        }
        else {
          let contname = rows[0].contname;
          let alertContaminantText = `Deleting contaminant ${contname}. Do you want to proceed?`;
          if (confirm(alertContaminantText)) {
            fetch("/deletecontaminant", {
              method: "POST",
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ "contname": contname })
            }).then(res => {
              if (res.status == 200) {
                res.text().then(text => showSuccessAlert(text));
                refreshContaminantTable();
              }
              else {
                res.text().then(text => showFailAlert(text));
              }
            });
          } else {
            console.log('Canceled deletion.');
          }
        }
      })
    });
  </script>

  <br>
  <!-- SAFETY MEASURE -->
  <div class="container" style="width:80%">
    <div style="position:absolute;">
      <button type="button" class="btn btn-success" id="addSafetyMeasureButton" data-toggle="modal"
        data-target="#addSafetyMeasureModal">Add</button>
      <button type="button" class="btn btn-info" id="updateSafetyMeasureButton">Update</button>
      <button type="button" class="btn btn-danger" id="deleteSafetyMeasureButton">Delete</button>
    </div>
    <table id="safetymeasuretable"></table>
  </div>

  <div class="modal fade" id="addSafetyMeasureModal" tabindex="-1" role="dialog"
    aria-labelledby="addSafetyMeasureModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <form id="addSafetyMeasureForm" method="post">
          <div class="modal-header">
            <h5 class="modal-title" id="addSafetyMeasureModalLabel">Add a Safety Measure</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="container alert alert-danger" id="addSafetyMeasureFailAlert" role="alert" style="margin-top:0px; margin-bottom:20px">
              <span>Error</span>
              <button type="button" id="addSafetyMeasureFailAlertCloseButton" class="close" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="form-group"> <input class="form-control" name="contname" type="text"
                placeholder="Contaminant Name" required> </div>
            <div class="form-group"> <input class="form-control" name="lower" type="number" step="any"
                placeholder="Lower Threshold" required> </div>
            <div class="form-group"> <input class="form-control" name="upper" type="number" step="any"
                placeholder="Upper Threshold" required> </div>
            <div class="form-group"> <input class="form-control" name="message" type="text"
                placeholder="Safety Message"> </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Discard</button>
            <button type="submit" class="btn btn-primary">Submit</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="updateSafetyMeasureModal" tabindex="-1" role="dialog"
    aria-labelledby="updateSafetyMeasureLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <form id="updateSafetyMeasureForm" method="post">
          <div class="modal-header">
            <h5 class="modal-title" id="updateSafetyMeasureModalLabel">Update a Safety Measure</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="modal-body">
              <div class="container alert alert-danger" id="updateSafetyMeasureFailAlert" role="alert"
                style="margin-top:0px; margin-bottom:20px">
                <span>Error</span>
                <button type="button" id="updateSafetyMeasureFailAlertCloseButton" class="close" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="form-group"> <label for="supdatecontname">Contaminant Name</label> <input class="form-control"
                  id="supdatecontname" name="contname" type="text" placeholder="Contaminant Name" readonly="readonly"
                  required> </div>
              <div class="form-group"> <label for="updatelower">Lower Threshold</label> <input class="form-control"
                  id="updatelower" name="lower" type="number" step="any" placeholder="Lower Threshold"
                  readonly="readonly" required> </div>
              <div class="form-group"> <label for="updateupper">Upper Threshold</label> <input class="form-control"
                  id="updateupper" name="upper" type="number" step="any" placeholder="Upper Threshold"
                  readonly="readonly" required> </div>
              <div class="form-group"> <label for="updatemessage">Safety Message</label> <input class="form-control"
                  id="updatemessage" name="message" type="text" placeholder="Safety Message"> </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Discard</button>
            <button type="submit" class="btn btn-primary">Submit</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>

    $('#addSafetyMeasureFailAlertCloseButton').on('click', function (e) {
      $('#addSafetyMeasureFailAlert').hide();
    });
    $('#addSafetyMeasureFailAlert').hide();

    $('#updateSafetyMeasureFailAlertCloseButton').on('click', function (e) {
      $('#updateSafetyMeasureFailAlert').hide();
    });
    $('#updateSafetyMeasureFailAlert').hide();

    var $safetymeasuretable = $('#safetymeasuretable');

    function refreshSafetyMeasureTable() {
      $safetymeasuretable.bootstrapTable('destroy');
      loadSafetyMeasures();
    }

    $('#addSafetyMeasureForm').submit(function (e) {
      e.preventDefault();
      $.ajax({
        type: 'POST',
        url: '/addsafetymeasure',
        data: $(this).serialize(),
        success: msg => {
          showSuccessAlert(msg);
          $('#addSafetyMeasureModal').modal('hide');
          $("#addSafetyMeasureForm").trigger('reset');
          refreshSafetyMeasureTable();
        },
        error: msg => {
          $('#addSafetyMeasureFailAlert').children('span').first().text(msg.responseText);
          $('#addSafetyMeasureFailAlert').show();
        },
      });
    })

    $('#updateSafetyMeasureForm').submit(function (e) {
      e.preventDefault();
      $.ajax({
        type: 'POST',
        url: '/updatesafetymeasure',
        data: $(this).serialize(),
        success: msg => {
          showSuccessAlert(msg);
          $('#updateSafetyMeasureModal').modal('hide');
          $("#updateSafetyMeasureForm").trigger('reset');
          refreshSafetyMeasureTable();
        },
        error: msg => {
          $('#updateSafetyMeasureFailAlert').children('span').first().text(msg.responseText);
          $('#updateSafetyMeasureFailAlert').show();
        },
      });
    })

    function loadSafetyMeasures() {
      fetch('/getsafetymeasures').then(response => response.text().then(rows => {
        rows = JSON.parse(rows);
        $safetymeasuretable.bootstrapTable({
          clickToSelect: true,
          multipleSelectRow: true,
          pagination: true,
          pageSize: 10,
          search: true,
          columns: [{
            field: 'checkbox',
            checkbox: true,
          }, {
            field: 'contname',
            title: 'Contaminant Name'
          }, {
            field: 'lower',
            title: 'Lower Threshold',
          },
          {
            field: 'upper',
            title: 'Upper Threshold',
          },
          {
            field: 'message',
            title: 'Safety Message',
          }
          ],
          data: rows
        });
      }));
    }
    loadSafetyMeasures();

    function fillSafetyMeasureUpdateForm(row) {
      for (let key in row) {
        if (key == 'checkbox') { continue; }
        else {
          let value = row[key];
          let updateId = `update${key}`;
          if (key == 'contname') {updateId = `supdate${key}`;}
          document.getElementById(updateId).setAttribute('value', value);
        }
      }
    }

    var $updateSafetyMeasureButton = $('#updateSafetyMeasureButton');
    $(function () {
      $updateSafetyMeasureButton.click(function () {
        $('#updateSafetyMeasureFailAlert').hide();
        rows = $safetymeasuretable.bootstrapTable('getSelections');
        if (rows.length < 1) {
          alert("Please select a safety measure to update.");
        }
        else if (rows.length > 1) {
          alert("Multiple safety measures are selected. Please click on a single safety measure to update.");
        }
        else {
          $('#updateSafetyMeasureModal').modal('show');
          fillSafetyMeasureUpdateForm(rows[0]);
        }
      })
    });

    var $deleteSafetyMeasureButton = $('#deleteSafetyMeasureButton');
    $(function () {
      $deleteSafetyMeasureButton.click(function () {
        rows = $safetymeasuretable.bootstrapTable('getSelections');
        if (rows.length < 1) {
          alert("Please select a safety measure to delete.");
        }
        else if (rows.length > 1) {
          alert("Multiple safety measures are selected. Please select a single safety measure to delete.");
          /*
          let alertMultipleSafetyMeasureText = "You have selected multiple contaminants to delete: ";
          for (let index in rows) {
              alertMultipleSafetyMeasureText += `(${rows[index].contname}, ${rows[index].abovethreshold}), `;
          }
          alertMultipleSafetyMeasureText = alertMultipleSafetyMeasureText.substring(0, alertMultipleSafetyMeasureText.length-2);
          alertMultipleSafetyMeasureText += ". Do you want to proceed?"
          if (confirm(alertMultipleSafetyMeasureText)) {
            // deleteMultipleFacilities(...);
            console.log('Deleted multiple safety measures.');
          } else {
            console.log('Canceled multiple deletion.');
          }
          */
        }
        else {
          let contname = rows[0].contname;
          let lower = rows[0].lower;
          let upper = rows[0].upper;
          let alertSafetyMeasureText = `Deleting safety measure (${contname}, ${lower} ${upper}). Do you want to proceed?`;
          if (confirm(alertSafetyMeasureText)) {
            fetch("/deletesafetymeasure", {
              method: "POST",
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ "contname": contname, "lower": lower, "upper": upper })
            }).then(res => {
              if (res.status == 200) {
                res.text().then(text => showSuccessAlert(text));
                refreshSafetyMeasureTable();
              }
              else {
                res.text().then(text => showFailAlert(text));
              }
            });
          } else {
            console.log('Canceled deletion.');
          }
        }
      })
    });
  </script>

</body>

</html>